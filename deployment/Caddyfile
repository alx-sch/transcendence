# For local hosting:
# Redirect HTTP to HTTPS
localhost:80 {
    redir https://{host}:8443{uri} 308
}

# HTTPS site
localhost:443 {
    # Use self-signed certs for dev
    tls internal

    # ---------------------
    # API Proxy
    # ---------------------
    # If this matches, Caddy STOPS here and runs the proxy.
    # This strips "/api" so the backend receives just "/users"
    handle_path /api/* {
        reverse_proxy user-service:3000
    }

    # ---------------------
    # Frontend SPA
    # ---------------------
    # This only runs if the path did NOT match /api/*
    handle {
        root * /srv/dist
        try_files {path} /index.html
        file_server
    }
}

# For real production (delete the 'localhost' block above and use this):
#
# your-domain.com {
#     # 1. Handle API requests
#     reverse_proxy /api/* backend:3000
#
#     # 2. Handle Frontend
#     root * /srv/dist
#     try_files {path} /index.html
#     file_server
# }
